AQA: Автоматические тесты для AI Translator & Critic (Flask Edition)

Цель
----
Документ описывает рекомендуемые автоматические тесты, шаги их выполнения и то, что они проверяют.

Категории тестов
----------------
- Unit tests (pytest): быстрые, локальные, без реальных HTTP-запросов (мокаем).
- Integration tests (pytest): проверяют связку обработчика формы и клиента при моках ответа from Mentorpiece.
- End-to-end (E2E) / UI tests: эмуляция пользователя (Selenium/Playwright) — опционально.

Рекомендуемые автотесты
----------------------
1) Unit: `extract_text_from_response` (покрытие вариантов ответов)
   - Входы: ответ с `choices[0].text`, `choices[0].message.content`, `result`, `outputs[0].content`, неожиданные структуры.
   - Ожидаемое поведение: корректный извлечённый текст или читаемое представление JSON.
   - Что проверяет: парсер устойчив к разным shape ответов API.

2) Unit: `call_mentorpiece` (headers, payload)
   - Мокаем `requests.post`.
   - Проверяем: передаются заголовки `Content-Type` и `Authorization` (Bearer из env), payload содержит `model` и `prompt`, и функция возвращает json().
   - Что проверяет: корректность формирования запроса и использование ключа из окружения.

3) Unit: `translate_text` и `judge_translation` (интеграция функций)
   - Мокаем `call_mentorpiece`, возвращаем заранее подготовленные ответы.
   - Проверяем: `translate_text` возвращает ожидаемый перевод; `judge_translation` возвращает ожидаемую критику.
   - Что проверяет: правильное формирование промптов и пайплайн извлечения текста.

4) Integration: POST / (флоу "Перевести")
   - Мокаем `call_mentorpiece` для переводчика.
   - Выполняем POST через Flask test client с action=translate.
   - Проверяем, что в HTML рендерится перевод.
   - Что проверяет: связь формы → backend → отображение результата.

5) Integration: POST / (флоу "Оценить")
   - Мокаем два вызова: перевод + вызов судьи (judge).
   - POST с action=judge, проверяем в ответе наличие вердикта судьи.
   - Что проверяет: последовательные вызовы и отображение вердикта.

6) Error handling: отсутствие ключа API / ошибки сети
   - Мокаем `requests.post` чтобы бросал `requests.exceptions.RequestException` или убираем env var `MENTORPIECE_API_KEY`.
   - Проверяем: приложение корректно показывает сообщение ошибки и не падает с 500 (или обрабатывает исключение ожидаемым образом).
   - Что проверяет: устойчивость к ошибкам внешнего API.

7) E2E / UI (опционально): полный сценарий пользователя
   - Использовать Playwright / Selenium.
   - Шаги: открыть `/`, ввести текст, выбрать язык, нажать "Перевести"; мокировать HTTP-ответы на уровне прокси/интерцептора или запускать локальный stub сервиса.
   - Проверить: UI обновился, перевод и/или вердикт судьи отображаются.
   - Что проверяет: пользовательский путь целиком.

Практические заметки по написанию тестов
--------------------------------------
- Используйте `pytest` и `monkeypatch` для моков `requests.post` и/или `call_mentorpiece`.
- Для unit/integration тестов держите тестовые данные (fixtures) рядом в `tests/fixtures/`.
- Для E2E удобно использовать Playwright с перехватом сетевого трафика (`route`), чтобы возвращать заранее подготовленные ответы от Mentorpiece.
- Покрывайте кейсы с пустым вводом, очень длинным текстом и не-UTF8 символами.
- Будьте внимательны к временам ожидания (timeouts) при моках.

Как запускать тесты локально
--------------------------
1) Установить зависимости (в виртуальном окружении):

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

2) Запуск всех unit/integration тестов:

```bash
pytest -q
```

3) Если добавите E2E с Playwright, установить и запустить его:

```bash
pip install playwright
playwright install
pytest tests/e2e -q
```

Примеры команд для CI
---------------------
- Установить зависимости и запустить `pytest`.
- Для E2E добавить шаг установки Playwright и запуск тестов.

GitHub Actions
--------------
Добавлен workflow `.github/workflows/ci.yml`:
- запускает `pytest` для unit/integration при `push`/`pull_request`.
- содержит опциональную задачу `e2e`, которую можно запустить вручную через `workflow_dispatch` с вводом `run_e2e=true`. Эта задача устанавливает Playwright и браузеры и запускает `pytest tests/e2e`.

# Пример ручного запуска E2E в GitHub: Actions → Run workflow → set `run_e2e=true`


Ожидаемая метрика качества
--------------------------
- Unit coverage: >= 80% логики функций `extract_text_from_response`, `call_mentorpiece`, `translate_text`, `judge_translation`.
- Все integration tests должны быть зелёными в PR перед слиянием.

Контакты и поддержка
---------------------
Если нет доступа к реальному API ключу — используйте мок-ответы. Для интеграции с реальным Mentorpiece, обсудите формат payload/response с командой Backend/API.

Файл был добавлен в репозитории: `AQA_README.txt`
